name: Release macos bundle

on: [push]

jobs:
  build:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v1

    - name: Install Perl
      run: brew install perl && brew link perl
    - name: Install XML::Parser
      run: perl -MCPAN -e 'install XML::Parser'

    - name: Download gtk-osx-setup.sh
      run: curl https://gitlab.gnome.org/GNOME/gtk-osx/raw/master/gtk-osx-setup.sh --output gtk-osx-setup.sh
    - name: Chmod +x gtk-osx-setup.sh
      run: chmod +x ./gtk-osx-setup.sh
    - name: Set flags
      run: |
        sed -i.bak '1 a \
        set -x' ./gtk-osx-setup.sh
    - name: Bump pipenv
      run: sed -i.bak 's/pipenv==2018\.10\.09/pipenv==2018.11.26/' ./gtk-osx-setup.sh
    - name: Bump python
      run: sed -i.bak 's/python_version = "3.6"/python_version = "3.7"/' ./gtk-osx-setup.sh
    - name: Run gtk-osx-setup.sh
      run: ./gtk-osx-setup.sh
      shell: bash

    - name: patch zlib
      run: sed -i.bak 's/<autotools id="zlib" autogen-sh="configure">/<autotools id="zlib" autogen-sh="configure" supports-unknown-configure-options="false">/' ~/Source/jhbuild/modulesets/bootstrap.modules

    - run: ls -aR > /tmp/dir.txt
    - run: tar -czf ./dump.tar.xz ~/Source ~/.new_local /tmp/dir.txt

    - uses: actions/upload-artifact@v1
      with:
        name: dump.tar.xz
        path: ./dump.tar.xz

    - run: cp jhbuildrc ~/.config/jhbuildrc

    - run: ~/.new_local/bin/jhbuild bootstrap
    - run: ~/.new_local/bin/jhbuild bootstrap-gtk-osx
    - run: ~/.new_local/bin/jhbuild build meta-gtk-osx-bootstrap meta-gtk-osx-gtk3

    - run: tar -czf ./gtk.tar.xz ~/gtk

    - uses: actions/upload-artifact@v1
      with:
        name: gtk.tar.xz
        path: ./gtk.tar.xz
